<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Hotmart – Webhook → Firestore</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- Chart.js (opcional p/ gráfico) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root {
    --bg:#0b0f14; --card:#10161d; --muted:#8aa0b2; --fg:#e8f0ff; --accent:#32d583; --border:#1f2a36; --danger:#ef4444; --ok:#22c55e; --warn:#f59e0b;
  }
  * { box-sizing: border-box }
  body { margin:0; background:var(--bg); color:var(--fg); font:14px system-ui,Segoe UI,Roboto,Ubuntu,Arial }
  a { color: var(--accent); text-decoration: none }
  .wrap { max-width:1200px; margin:24px auto; padding:16px }
  h1 { margin:0 0 8px; font-size:clamp(18px,2.2vw,28px) }
  .sub { color:var(--muted); margin-bottom:16px }
  .row { display:grid; grid-template-columns: repeat(12, 1fr); gap:12px }
  .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
  .kpi { display:flex; flex-direction:column; gap:6px }
  .kpi .label { color:var(--muted); font-size:12px }
  .kpi .val { font-size:20px; font-weight:600 }
  .kpi.ok .val { color:var(--ok) }
  .kpi.danger .val { color:var(--danger) }
  .kpi.warn .val { color:var(--warn) }
  .filters label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
  .filters input, .filters select { width:100%; background:#0e141b; color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:8px }
  .filters .chipset { display:flex; flex-wrap:wrap; gap:6px }
  .chip { border:1px solid var(--border); background:#0e141b; padding:6px 10px; border-radius:999px; cursor:pointer; font-size:12px }
  .chip.active { border-color:var(--accent); color:#eafff5; }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap }
  .btn { background:var(--accent); color:#062a17; border:0; padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer }
  .btn.ghost { background:#0e141b; color:var(--fg); border:1px solid var(--border) }
  table { width:100%; border-collapse:separate; border-spacing:0; }
  th, td { text-align:left; padding:10px 8px; border-bottom:1px solid var(--border); font-variant-numeric: tabular-nums; }
  th { color:var(--muted); font-weight:600; position:sticky; top:0; background:var(--card); z-index:1 }
  .tag { padding:3px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px }
  .tag.ok { border-color:#1d3; color:#1d3 }
  .tag.bad { border-color:#e66; color:#e66 }
  .tag.warn { border-color:#fb3; color:#fb3 }
  .grid-12 { grid-column: span 12 }
  .grid-6 { grid-column: span 6 }
  .grid-4 { grid-column: span 4 }
  .grid-3 { grid-column: span 3 }
  .right { text-align:right }
  .muted { color:var(--muted) }
  .table-wrap { max-height: 520px; overflow:auto; border:1px solid var(--border); border-radius:12px }
  .foot { display:flex; justify-content:space-between; align-items:center; margin-top:10px; color:var(--muted) }
  @media (max-width:900px){
    .row { grid-template-columns: repeat(2, 1fr) }
    .grid-6, .grid-4, .grid-3 { grid-column: span 2 }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Notificações Hotmart — Dashboard</h1>
  <div class="sub">Tempo real a partir do Firestore (via Webhook). Filtros locais + exportação CSV.</div>

  <!-- KPIs -->
  <div class="row">
    <div class="card kpi grid-3"><div class="label">Eventos (total)</div><div class="val" id="kpi-total">–</div></div>
    <div class="card kpi ok grid-3"><div class="label">Aprovadas / Completas</div><div class="val" id="kpi-aprovadas">–</div></div>
    <div class="card kpi warn grid-3"><div class="label">Pendentes / Overdue</div><div class="val" id="kpi-pendentes">–</div></div>
    <div class="card kpi danger grid-3"><div class="label">Reembolsos / Chargebacks</div><div class="val" id="kpi-refunds">–</div></div>
    <div class="card kpi grid-6"><div class="label">Receita (aprovado)</div><div class="val" id="kpi-receita">–</div></div>
    <div class="card kpi grid-6"><div class="label">Receita últimas 24h</div><div class="val" id="kpi-receita24">–</div></div>
  </div>

  <!-- Filtros -->
  <div class="card filters" style="margin-top:12px">
    <div class="row">
      <div class="grid-3">
        <label>Data inicial</label>
        <input type="date" id="flt-desde">
      </div>
      <div class="grid-3">
        <label>Data final</label>
        <input type="date" id="flt-ate">
      </div>
      <div class="grid-3">
        <label>Produto</label>
        <select id="flt-produto"><option value="">Todos</option></select>
      </div>
      <div class="grid-3">
        <label>Método de pagamento</label>
        <select id="flt-metodo"><option value="">Todos</option></select>
      </div>

      <div class="grid-3">
        <label>E-mail (contém)</label>
        <input id="flt-email" placeholder="cliente@exemplo.com">
      </div>
      <div class="grid-3">
        <label>Transação (contém)</label>
        <input id="flt-tx" placeholder="TX id...">
      </div>
      <div class="grid-6">
        <label>Evento/Status</label>
        <div id="flt-eventos" class="chipset"></div>
      </div>

      <div class="grid-12 toolbar">
        <button class="btn" id="btn-aplicar">Aplicar filtros</button>
        <button class="btn ghost" id="btn-limpar">Limpar</button>
        <button class="btn ghost" id="btn-export">Exportar CSV</button>
      </div>
    </div>
  </div>

  <!-- Gráfico -->
  <div class="row" style="margin-top:12px">
    <div class="card grid-12">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card" style="margin-top:12px">
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Recebido</th>
            <th>Evento</th>
            <th>Status</th>
            <th>Produto</th>
            <th>Transação</th>
            <th>Comprador</th>
            <th class="right">Valor</th>
            <th>Moeda</th>
            <th>Método</th>
            <th>Parcelas</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="foot">
      <div id="foot-count">–</div>
      <div class="muted">Hotmart → Webhook → Firestore → Dashboard</div>
    </div>
  </div>
</div>

<script>
/** =======================
 *  1) Firebase Setup
 *  ======================= */
const firebaseConfig = {
  // PREENCHA AQUI:
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_PROJECT.firebaseapp.com",
  projectId: "SEU_PROJECT_ID",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Autenticação anônima (ajuste regras depois)
auth.signInAnonymously().catch(console.error);

/** =======================
 *  2) Utils
 *  ======================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const fmtBRL = (v, c='BRL') => (v==null?'-': new Intl.NumberFormat('pt-BR',{style:'currency',currency:c}).format(Number(v)));
const fmtNum = (v) => (v==null?'-': new Intl.NumberFormat('pt-BR').format(Number(v)));
const fmtDate = (d) => d ? new Date(d).toLocaleString('pt-BR') : '-';

function toCSV(rows) {
  if (!rows.length) return '';
  const cols = Object.keys(rows[0]);
  const head = cols.join(',');
  const body = rows.map(r => cols.map(k => {
    const cell = r[k] ?? '';
    const s = String(cell).replaceAll('"','""');
    return `"${s}"`;
  }).join(',')).join('\n');
  return head + '\n' + body;
}

function download(filename, text) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:'text/csv;charset=utf-8;'}));
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function uniq(xs) { return Array.from(new Set(xs.filter(Boolean))); }

/** =======================
 *  3) Estado e Filtros
 *  ======================= */
const EVENT_CHOICES = [
  'PURCHASE_APPROVED','COMPLETE','APPROVED','AWAITING_PAYMENT','CANCELLED',
  'OVERDUE','EXPIRED','REFUNDED','CHARGEBACK','REFUND_REQUEST'
];

const state = {
  items: [],
  filtered: [],
  products: [],
  methods: [],
  chart: null,
  filters: {
    desde: '',
    ate: '',
    produto: '',
    metodo: '',
    eventos: new Set(),
    email: '',
    tx: '',
  }
};

// Chips de evento
const chipWrap = $('#flt-eventos');
EVENT_CHOICES.forEach(ev => {
  const c = document.createElement('button');
  c.className = 'chip';
  c.textContent = ev;
  c.dataset.value = ev;
  c.addEventListener('click', () => {
    if (state.filters.eventos.has(ev)) {
      state.filters.eventos.delete(ev); c.classList.remove('active');
    } else {
      state.filters.eventos.add(ev); c.classList.add('active');
    }
  });
  chipWrap.appendChild(c);
});

// Preenche selects quando chegar dados
function refreshSelects() {
  const selProd = $('#flt-produto');
  const selMet = $('#flt-metodo');
  const curProd = selProd.value, curMet = selMet.value;
  selProd.innerHTML = '<option value="">Todos</option>' + uniq(state.products).map(p=>`<option>${p}</option>`).join('');
  selMet.innerHTML  = '<option value="">Todos</option>' + uniq(state.methods).map(m=>`<option>${m}</option>`).join('');
  if (curProd) selProd.value = curProd;
  if (curMet) selMet.value = curMet;
}

/** =======================
 *  4) Leitura em tempo real (janela de 180 dias)
 *  ======================= */
const DAYS = 180;
const startDate = new Date(); startDate.setDate(startDate.getDate() - DAYS);

auth.onAuthStateChanged(() => {
  db.collection('hotmartEvents')
    .where('receivedAt', '>=', startDate)
    .orderBy('receivedAt', 'desc')
    .onSnapshot(snap => {
      const items = [];
      snap.forEach(doc => {
        const d = doc.data();
        const rec = {
          id: doc.id,
          receivedAt: d.receivedAt?.toDate ? d.receivedAt.toDate() : (d.receivedAt ? new Date(d.recebidoAt) : null),
          event: d.event || '',
          status: d.status || '',
          product: d.product?.name || d.product?.id || '',
          transaction: d.transaction || '',
          buyer: d.buyer?.name ? `${d.buyer.name} <${d.buyer.email||''}>` : (d.buyer?.email || ''),
          email: (d.buyer?.email || '').toLowerCase(),
          amount: d.amount ?? null,
          currency: d.currency || 'BRL',
          method: d.payment?.method || '',
          installments: d.payment?.installments ?? '',
        };
        items.push(rec);
      });
      state.items = items;
      state.products = items.map(i=>i.product);
      state.methods = items.map(i=>i.method);
      refreshSelects();
      applyFilters();
    }, err => console.error(err));
});

/** =======================
 *  5) Aplicar Filtros + KPIs + Tabela + Gráfico
 *  ======================= */
function inRange(date, desde, ate) {
  if (!date) return true;
  const t = +date;
  if (desde) { const td = +new Date(desde + 'T00:00:00'); if (t < td) return false; }
  if (ate)   { const ta = +new Date(ate   + 'T23:59:59'); if (t > ta) return false; }
  return true;
}
function contains(s, q) { return !q || (s||'').toLowerCase().includes(q.toLowerCase()); }

function applyFilters() {
  const f = state.filters;
  f.desde = $('#flt-desde').value;
  f.ate   = $('#flt-ate').value;
  f.produto = $('#flt-produto').value;
  f.metodo  = $('#flt-metodo').value;
  f.email = $('#flt-email').value.trim().toLowerCase();
  f.tx    = $('#flt-tx').value.trim().toLowerCase();

  const setEv = f.eventos;
  let out = state.items.filter(i =>
    inRange(i.receivedAt, f.desde, f.ate) &&
    (!f.produto || i.product === f.produto) &&
    (!f.metodo || i.method === f.metodo) &&
    (!setEv.size || setEv.has(i.event) || setEv.has(i.status)) &&
    contains(i.email, f.email) &&
    contains((i.transaction||'').toLowerCase(), f.tx)
  );

  state.filtered = out;
  renderKPIs(out);
  renderTable(out);
  renderChart(out);
}

function renderKPIs(rows) {
  const total = rows.length;
  const aprov = rows.filter(r => ['PURCHASE_APPROVED','APPROVED','COMPLETE'].includes(r.event) || ['APPROVED','COMPLETE'].includes(r.status));
  const pend  = rows.filter(r => ['AWAITING_PAYMENT','OVERDUE'].includes(r.event) || ['AWAITING_PAYMENT','OVERDUE'].includes(r.status));
  const neg   = rows.filter(r => ['REFUNDED','CHARGEBACK','CANCELLED','EXPIRED'].includes(r.event) || ['REFUNDED','CHARGEBACK','CANCELLED','EXPIRED'].includes(r.status));

  const receita = aprov.reduce((s, r) => s + (Number(r.amount)||0), 0);
  const lim24 = Date.now() - 24*60*60*1000;
  const receita24 = aprov.filter(r => r.receivedAt && (+r.receivedAt >= lim24))
                         .reduce((s, r) => s + (Number(r.amount)||0), 0);

  $('#kpi-total').textContent = fmtNum(total);
  $('#kpi-aprovadas').textContent = fmtNum(aprov.length);
  $('#kpi-pendentes').textContent = fmtNum(pend.length);
  $('#kpi-refunds').textContent = fmtNum(neg.length);
  $('#kpi-receita').textContent = fmtBRL(receita);
  $('#kpi-receita24').textContent = fmtBRL(receita24);
  $('#foot-count').textContent = `${fmtNum(total)} registro(s) visíveis`;
}

function renderTable(rows) {
  const tb = $('#tbody');
  tb.innerHTML = rows.map(r => `
    <tr>
      <td>${fmtDate(r.receivedAt)}</td>
      <td><span class="tag ${['PURCHASE_APPROVED','APPROVED','COMPLETE'].includes(r.event)?'ok': ['REFUNDED','CHARGEBACK','CANCELLED','EXPIRED'].includes(r.event)?'bad':'warn'}">${r.event||'-'}</span></td>
      <td>${r.status||'-'}</td>
      <td>${r.product||'-'}</td>
      <td>${r.transaction||'-'}</td>
      <td>${r.buyer||'-'}</td>
      <td class="right">${r.amount!=null? fmtBRL(r.amount, r.currency) : '-'}</td>
      <td>${r.currency||'-'}</td>
      <td>${r.method||'-'}</td>
      <td>${r.installments||'-'}</td>
    </tr>
  `).join('');
}

function renderChart(rows) {
  const byDay = new Map();
  rows.forEach(r => {
    const d = r.receivedAt ? new Date(r.receivedAt) : null;
    const key = d ? d.toISOString().slice(0,10) : 's/ data';
    const add = ['PURCHASE_APPROVED','APPROVED','COMPLETE'].includes(r.event) ? Number(r.amount)||0 : 0;
    byDay.set(key, (byDay.get(key)||0) + add);
  });
  const labels = Array.from(byDay.keys()).sort();
  const data = labels.map(k => byDay.get(k));

  if (state.chart) state.chart.destroy();
  const ctx = document.getElementById('chart');
  state.chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Receita (aprovado) por dia', data }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ display:false } } }
  });
}

/** =======================
 *  6) UI actions
 *  ======================= */
$('#btn-aplicar').addEventListener('click', applyFilters);
$('#btn-limpar').addEventListener('click', () => {
  $('#flt-desde').value=''; $('#flt-ate').value='';
  $('#flt-produto').value=''; $('#flt-metodo').value='';
  $('#flt-email').value=''; $('#flt-tx').value='';
  state.filters.eventos.clear(); $$('.chip').forEach(c=>c.classList.remove('active'));
  applyFilters();
});

$('#btn-export').addEventListener('click', () => {
  const rows = state.filtered.map(r => ({
    receivedAt: r.receivedAt ? r.receivedAt.toISOString() : '',
    event: r.event, status: r.status,
    product: r.product, transaction: r.transaction,
    buyer: r.buyer, email: r.email,
    amount: r.amount, currency: r.currency,
    method: r.method, installments: r.installments
  }));
  download(`hotmartExport_${Date.now()}.csv`, toCSV(rows));
});
</script>
</body>
</html>
